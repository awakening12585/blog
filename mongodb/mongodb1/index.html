<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB副本集搭建 | 早有觉悟</title>
    <meta name="description" content="开始">
    <link rel="icon" href="/blog/favicon.ico">
    
    <link rel="preload" href="/blog/assets/css/0.styles.1f478cd9.css" as="style"><link rel="preload" href="/blog/assets/js/app.c6a0e20f.js" as="script"><link rel="preload" href="/blog/assets/js/40.9bec41c0.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.bf97e52d.js"><link rel="prefetch" href="/blog/assets/js/11.a498b246.js"><link rel="prefetch" href="/blog/assets/js/12.856aa61d.js"><link rel="prefetch" href="/blog/assets/js/13.7d8f8331.js"><link rel="prefetch" href="/blog/assets/js/14.cb4b7fce.js"><link rel="prefetch" href="/blog/assets/js/15.d50e41e9.js"><link rel="prefetch" href="/blog/assets/js/16.fd9be6fd.js"><link rel="prefetch" href="/blog/assets/js/17.93c57d6e.js"><link rel="prefetch" href="/blog/assets/js/18.93be17db.js"><link rel="prefetch" href="/blog/assets/js/19.ba590e87.js"><link rel="prefetch" href="/blog/assets/js/2.8a2241f0.js"><link rel="prefetch" href="/blog/assets/js/20.c5a2540a.js"><link rel="prefetch" href="/blog/assets/js/21.bb64c560.js"><link rel="prefetch" href="/blog/assets/js/22.7701b9ed.js"><link rel="prefetch" href="/blog/assets/js/23.8a11c47a.js"><link rel="prefetch" href="/blog/assets/js/24.30b50f31.js"><link rel="prefetch" href="/blog/assets/js/25.d38803a1.js"><link rel="prefetch" href="/blog/assets/js/26.f7b8bd2d.js"><link rel="prefetch" href="/blog/assets/js/27.802c2702.js"><link rel="prefetch" href="/blog/assets/js/28.366eeeb0.js"><link rel="prefetch" href="/blog/assets/js/29.52e7d088.js"><link rel="prefetch" href="/blog/assets/js/3.95048b86.js"><link rel="prefetch" href="/blog/assets/js/30.111ffc3a.js"><link rel="prefetch" href="/blog/assets/js/31.f31c1598.js"><link rel="prefetch" href="/blog/assets/js/32.08fc7207.js"><link rel="prefetch" href="/blog/assets/js/33.46c6941e.js"><link rel="prefetch" href="/blog/assets/js/34.fad3b03c.js"><link rel="prefetch" href="/blog/assets/js/35.173a72c5.js"><link rel="prefetch" href="/blog/assets/js/36.b9f444c3.js"><link rel="prefetch" href="/blog/assets/js/37.1143f44b.js"><link rel="prefetch" href="/blog/assets/js/38.b009ad2e.js"><link rel="prefetch" href="/blog/assets/js/39.005a1991.js"><link rel="prefetch" href="/blog/assets/js/4.4c51fbb3.js"><link rel="prefetch" href="/blog/assets/js/41.7411c71f.js"><link rel="prefetch" href="/blog/assets/js/42.aa37ee99.js"><link rel="prefetch" href="/blog/assets/js/43.5f29a3cc.js"><link rel="prefetch" href="/blog/assets/js/44.8e4859d5.js"><link rel="prefetch" href="/blog/assets/js/45.a584ef1c.js"><link rel="prefetch" href="/blog/assets/js/46.97340da3.js"><link rel="prefetch" href="/blog/assets/js/47.7b06b391.js"><link rel="prefetch" href="/blog/assets/js/48.3e041161.js"><link rel="prefetch" href="/blog/assets/js/49.9627a7c7.js"><link rel="prefetch" href="/blog/assets/js/5.948e7a3c.js"><link rel="prefetch" href="/blog/assets/js/50.a1af66ed.js"><link rel="prefetch" href="/blog/assets/js/51.521efdb9.js"><link rel="prefetch" href="/blog/assets/js/52.7ed6cf2b.js"><link rel="prefetch" href="/blog/assets/js/53.64a97baa.js"><link rel="prefetch" href="/blog/assets/js/54.c92395c0.js"><link rel="prefetch" href="/blog/assets/js/55.75c42f8f.js"><link rel="prefetch" href="/blog/assets/js/56.e376196d.js"><link rel="prefetch" href="/blog/assets/js/57.45a5e30e.js"><link rel="prefetch" href="/blog/assets/js/58.4ad9cc85.js"><link rel="prefetch" href="/blog/assets/js/59.f4f99e42.js"><link rel="prefetch" href="/blog/assets/js/6.23e6df2a.js"><link rel="prefetch" href="/blog/assets/js/60.9837fa12.js"><link rel="prefetch" href="/blog/assets/js/61.1031cb70.js"><link rel="prefetch" href="/blog/assets/js/62.d96cbe08.js"><link rel="prefetch" href="/blog/assets/js/63.dab98ff9.js"><link rel="prefetch" href="/blog/assets/js/64.7897ff38.js"><link rel="prefetch" href="/blog/assets/js/7.e1131300.js"><link rel="prefetch" href="/blog/assets/js/8.2fe7de94.js"><link rel="prefetch" href="/blog/assets/js/9.55214cd9.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.1f478cd9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">早有觉悟</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/guide/markdown/" class="nav-link">导航</a></div><div class="nav-item"><a href="http://blog.zaoyoujuewu.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/awakening12585" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/guide/markdown/" class="nav-link">导航</a></div><div class="nav-item"><a href="http://blog.zaoyoujuewu.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/awakening12585" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub地址
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>基础学习</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/mongodb/base/anzhuang/" class="sidebar-link">MongoDB安装</a></li><li><a href="/blog/mongodb/base/rs/" class="sidebar-link">MongoDB 副本集搭建</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>常见操作</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog/mongodb/mongodb1/" class="active sidebar-link">MongoDB副本集搭建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/mongodb/mongodb1/#一、mongodb副本集简介" class="sidebar-link">一、MongoDB副本集简介</a></li><li class="sidebar-sub-header"><a href="/blog/mongodb/mongodb1/#二、部署准备" class="sidebar-link">二、部署准备</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="mongodb副本集搭建"><a href="#mongodb副本集搭建" aria-hidden="true" class="header-anchor">#</a> MongoDB副本集搭建</h1> <h2 id="一、mongodb副本集简介"><a href="#一、mongodb副本集简介" aria-hidden="true" class="header-anchor">#</a> 一、MongoDB副本集简介</h2> <p>单节点的 <kbd>MongoDB</kbd> 在数据的安全和冗余方面是比较低的，在生产环境中，我们为 <kbd>MongoDB</kbd>  配置副本集，这样可以提高数据的高可用性和安全性。</p> <p>副本集 ：是一组 <kbd>Mongod</kbd> 维护相同数据集的实例。副本集可以包含多个数据承载点和多个仲裁点。在承载数据的节点中，仅有一个节点被视为主节点，其他节点称为次节点。</p> <ul><li>==Primary 主节点，用于承担==</li> <li>==Secondary 次节点==</li> <li>==Arbiter 仲裁节点，也是属于次节点==</li></ul> <p>主节点接收所有的数据写入操作，主节点记录数据的所有更改，即<kbd>oplog</kbd>。</p> <ul><li><p>一个主节点两个次节点(一个<kbd>Secondary</kbd> 节点，一个<kbd>Arbiter</kbd> 节点)
<img src="https://img-blog.csdnimg.cn/20191022114327217.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8yODg0NjM2Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
将一个额外的<kbd>mongod</kbd>实例添加到副本集作为 仲裁节点。仲裁节点不维护数据集。仲裁节点的目的是通过响应其他副本集成员的心跳和选举请求来维护副本集中的选举。因为它们不存储数据集，所以仲裁节点可以是提供副本集仲裁功能的好方法，其资源成本比具有数据集的全功能副本集成员更低。如果您的副本集具有偶数个成员，请添加仲裁者以避免脑裂出现。</p></li> <li><p>主节点故障后重新选举主节点
<img src="https://img-blog.csdnimg.cn/20191022114550461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8yODg0NjM2Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">
在主节点未与配置中的其它成员通信超过 10s(默认为10s)的话，则符合条件的次节点将推选自己为主节点。</p></li></ul> <p><strong>在选举成功完成之前，副本集无法处理写入操作。</strong></p> <p><kbd><a href="https://docs.mongodb.com/manual/reference/replica-configuration/#rsconf.settings.electionTimeoutMillis" target="_blank" rel="noopener noreferrer">electionTimeoutMillis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></kbd> 默认值为10000(10s) ，我们可以根据自己的项目情况来升高或者降低该值，我们在更改该值的时候需要考虑到网络延迟等因素。</p> <p>默认情况下，副本集在选取新的主节点的等待时间不超过12秒(主要用于将原有主节点标记为不可用，并选举出新的主节点)。</p> <p>为了保持次节点与主节点的数据同步，MongoDB 使用两种方式进行数据的同步：</p> <ul><li>初始同步， 用于同步主节点的所有数据</li></ul> <blockquote><p>初始同步将所有的数据从副本集的一个成员复制到另外一个成员</p></blockquote> <ul><li>增量同步，在初始同步后不断复制新的数据</li></ul> <blockquote><p>在初始同步后不断复制数据，次节点从主节点中同步复制 Oplog，并在异步过程中应用这些操作</p></blockquote> <p><kbd><a href="https://www.cnblogs.com/operationhome/p/10688798.html" target="_blank" rel="noopener noreferrer">MongoDB-Oplog详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></kbd></p> <blockquote><p>副本集在部署前需要确定成员数据，副本集最多能有50个节点，但是只能有7个节点拥有被选举权，副本集需要具有奇数个投票成员，如果有偶数个的话，可以添加一个 仲裁者，来保证有奇数个成员，避免脑裂情况发生。
尽量使用 主机名 来寻找对应的节点，而不是使用 ip 地址，避免 ip 改变导致配置需要更改。</p></blockquote> <h2 id="二、部署准备"><a href="#二、部署准备" aria-hidden="true" class="header-anchor">#</a> 二、部署准备</h2> <p><kbd>1.部署需要更改 /etc/hosts 文件，将主机名和 ip 地址对应好，不应该使用ip。
2.使用统一的端口。
3.创建数据储存的位置、日志储存位置和配置文件的位置。
4.确定好副本集的名称
5.提前生成keyfile文件
6.前往官网下载安装包（本次教程使用的是官网编译的包，解压直接使用）</kbd></p> <p><kbd><a href="https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-4.0.13.tgz" target="_blank" rel="noopener noreferrer">安装包下载地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></kbd></p> <ul><li>配置服务器hosts文件</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>vim <span class="token operator">/</span>etc<span class="token operator">/</span>hosts
test1 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>1<span class="token punctuation">.</span>11<span class="token punctuation">(</span>替换为真是ip<span class="token punctuation">)</span>
test1 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>1<span class="token punctuation">.</span>12<span class="token punctuation">(</span>替换为真是ip<span class="token punctuation">)</span>
test1 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>1<span class="token punctuation">.</span>13<span class="token punctuation">(</span>替换为真是ip<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>将下载好的安装包上传至服务器并解压
<img src="https://img-blog.csdnimg.cn/20191022121949656.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8yODg0NjM2Nw==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li></ul> <blockquote><p>解压后将目录复制3份，分别命名为：mongodb-4.0.12-PRIMARY、mongodb-4.0.12-SECONDARY、mongodb-4.0.12-ARBITER，并将目录移动至/data目录下</p></blockquote> <p>==<strong>注：本次搭建副本集为测试环境，在一台服务器上完成的搭建，如需在正式环境下搭建将其余两个节点分发至不同服务器即可</strong>==</p> <ul><li>创建数据库相关目录</li></ul> <blockquote><p>提前创建好相关目录：db为数据库数据存储目录，logs为数据库日志存放目录，etc为数据库配置文件存放目录</p></blockquote> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span><span class="token punctuation">{</span>db<span class="token punctuation">,</span>logs<span class="token punctuation">,</span>etc<span class="token punctuation">}</span>
mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>SECONDARY<span class="token operator">/</span><span class="token punctuation">{</span>db<span class="token punctuation">,</span>logs<span class="token punctuation">,</span>etc<span class="token punctuation">}</span>
mkdir <span class="token operator">-</span>p <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>ARBITER<span class="token operator">/</span><span class="token punctuation">{</span>db<span class="token punctuation">,</span>logs<span class="token punctuation">,</span>etc<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>生成keyfile文件并将文件分发至3台服务器内数据库etc目录下</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>openssl rand <span class="token operator">-</span>base64 90 <span class="token operator">-</span>out <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>tools<span class="token operator">/</span>keyfile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>更改三个节点的 <kbd>keyFile</kbd> 文件权限</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>chmod 600 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>etc<span class="token operator">/</span>keyfile
chmod 600 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>SECONDARY<span class="token operator">/</span>etc<span class="token operator">/</span>keyfile
chmod 600 <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>ARBITER<span class="token operator">/</span>etc<span class="token operator">/</span>keyfile
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>上述准备工作完成之后，首次启动通过命令方式分别启动数据库</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>bin<span class="token operator">/</span>mongod <span class="token operator">--</span>dbpath=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>db <span class="token operator">--</span>logpath=<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>logs<span class="token operator">/</span>mongo<span class="token punctuation">.</span>log <span class="token operator">--</span>fork <span class="token operator">--</span>port 27017
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>==<strong>--dbpath:指定数据库存储位置
--logpath:指定日志存放位置
--fork:后台运行
--port:指定运行端口，如不指定为默认端口27017</strong>==</p> <ul><li>启动后匿名登录创建管理员账号</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>bin<span class="token operator">/</span>mongo

use admin

db<span class="token punctuation">.</span>createUser<span class="token punctuation">(</span><span class="token punctuation">{</span>user:<span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span><span class="token function">pwd</span>:<span class="token string">&quot;密码&quot;</span><span class="token punctuation">,</span>roles: <span class="token punctuation">[</span><span class="token punctuation">{</span> role: <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> db: <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>==<strong>3台数据库服务都需要使用此方法创建管理员用户</strong>==</p> <ul><li>管理员用户创建成功后，重启MongoDB服务（首先kill掉MongoDB数据库服务,然后通过添加下方配置文件内容来启动服务）</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code><span class="token function">ps</span> <span class="token operator">-</span>ef <span class="token punctuation">|</span> grep mongo <span class="token punctuation">|</span> awk <span class="token string">'{print $2}'</span> <span class="token punctuation">|</span> grep <span class="token operator">-</span>v grep <span class="token punctuation">|</span> xargs <span class="token function">kill</span> <span class="token operator">-</span>9 

vim <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>etc<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># mongod.conf</span>

<span class="token comment"># for documentation of all options, see:</span>
<span class="token comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span>

<span class="token comment"># Where and how to store data.</span>
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
  <span class="token key atrule">dbPath</span><span class="token punctuation">:</span> /data/mongodb<span class="token punctuation">-</span>4.0.12<span class="token punctuation">-</span>PRIMARY/db
  <span class="token key atrule">journal</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token comment">#  engine:</span>
<span class="token comment">#  mmapv1:</span>
<span class="token comment">#  wiredTiger:</span>

<span class="token comment"># where to write logging data.</span>
<span class="token key atrule">systemLog</span><span class="token punctuation">:</span>
  <span class="token key atrule">destination</span><span class="token punctuation">:</span> file
  <span class="token key atrule">logAppend</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/mongodb<span class="token punctuation">-</span>4.0.12<span class="token punctuation">-</span>PRIMARY/logs/mongodb.logs

<span class="token comment"># network interfaces</span>
<span class="token key atrule">net</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>
  <span class="token key atrule">bindIp</span><span class="token punctuation">:</span> 0.0.0.0


<span class="token key atrule">processManagement</span><span class="token punctuation">:</span>
  <span class="token key atrule">fork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token key atrule">authorization</span><span class="token punctuation">:</span> enabled
  <span class="token key atrule">keyFile</span><span class="token punctuation">:</span> <span class="token string">&quot;/data/mongodb-4.0.12-PRIMARY/etc/keyfile&quot;</span>
 <span class="token comment"># clusterAuthMode: &quot;keyFile&quot;</span>

<span class="token comment">#operationProfiling:</span>

<span class="token key atrule">replication</span><span class="token punctuation">:</span>
  <span class="token key atrule">replSetName</span><span class="token punctuation">:</span> smart360

<span class="token comment">#sharding:</span>

<span class="token comment">## Enterprise-Only Options:</span>

<span class="token comment">#auditLog:</span>

<span class="token comment">#snmp:</span>
<span class="token comment">#auth=ture</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>==<strong>3台服务器分别创建mongod.conf配置文件，内部参数根据自己实际目录而修改</strong>==</p> <ul><li>配置文件编辑好后分别启动3台数据库</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>bin<span class="token operator">/</span>mongo <span class="token operator">-</span>f <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>etc<span class="token operator">/</span>mongod<span class="token punctuation">.</span>conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>通过管理员的身份登录数据库</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mongodb<span class="token operator">-</span>4<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token operator">-</span>PRIMARY<span class="token operator">/</span>bin<span class="token operator">/</span>mongo localhost:27017<span class="token operator">/</span>admin <span class="token operator">-</span>u root <span class="token operator">-</span>p
<span class="token operator">*</span>输入创建管理员用户时的密码
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>创建副本集，主节点操作</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>&gt;rs<span class="token punctuation">.</span>initiate<span class="token punctuation">(</span><span class="token punctuation">{</span>_id:<span class="token string">'test'</span><span class="token punctuation">,</span>members: <span class="token punctuation">[</span><span class="token punctuation">{</span> _id: 0 <span class="token punctuation">,</span> host: <span class="token string">&quot;test1:27017&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;ok&quot;</span> : 1 <span class="token punctuation">}</span> <span class="token comment">#(返回次结果表示创建成功)</span>
<span class="token comment">#多次按下回车键，直到显示这个节点为Primary主节点</span>
test:PRIMARY&gt;
<span class="token comment">#接下来添加备节点</span>
test:PRIMARY&gt; rs<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">'test2:27017'</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;ok&quot;</span> : 1<span class="token punctuation">,</span>
    <span class="token string">&quot;operationTime&quot;</span> : Timestamp<span class="token punctuation">(</span>1555663440<span class="token punctuation">,</span> 1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&quot;<span class="token variable">$clusterTime</span>&quot;</span> : <span class="token punctuation">{</span>
        <span class="token string">&quot;clusterTime&quot;</span> : Timestamp<span class="token punctuation">(</span>1555663440<span class="token punctuation">,</span> 1<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;signature&quot;</span> : <span class="token punctuation">{</span>
            <span class="token string">&quot;hash&quot;</span> : BinData<span class="token punctuation">(</span>0<span class="token punctuation">,</span><span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;keyId&quot;</span> : NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">#添加仲裁节点</span>
test:PRIMARY&gt; rs<span class="token punctuation">.</span>addArb<span class="token punctuation">(</span><span class="token string">&quot;test3:27017&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;ok&quot;</span> : 1<span class="token punctuation">,</span>
    <span class="token string">&quot;operationTime&quot;</span> : Timestamp<span class="token punctuation">(</span>1555663631<span class="token punctuation">,</span> 1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&quot;<span class="token variable">$clusterTime</span>&quot;</span> : <span class="token punctuation">{</span>
        <span class="token string">&quot;clusterTime&quot;</span> : Timestamp<span class="token punctuation">(</span>1555663631<span class="token punctuation">,</span> 1<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;signature&quot;</span> : <span class="token punctuation">{</span>
            <span class="token string">&quot;hash&quot;</span> : BinData<span class="token punctuation">(</span>0<span class="token punctuation">,</span><span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;keyId&quot;</span> : NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">#查看当前配置</span>
test:PRIMARY&gt; rs<span class="token punctuation">.</span>conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#查看各节点身份</span>
test:PRIMARY&gt; rs<span class="token punctuation">.</span>status<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>次节点数据库操作</li></ul> <div class="language-powershell line-numbers-mode"><pre class="language-powershell"><code>test:SECONDARY&gt; show dbs<span class="token punctuation">;</span>  <span class="token comment"># 我们发现无法读写</span>
2019<span class="token operator">-</span>10<span class="token operator">-</span>22T14:40:40<span class="token punctuation">.</span>852<span class="token operator">+</span>0800 E QUERY    <span class="token namespace">[js]</span> Error: listDatabases failed:<span class="token punctuation">{</span>
    <span class="token string">&quot;operationTime&quot;</span> : Timestamp<span class="token punctuation">(</span>1555664675<span class="token punctuation">,</span> 1<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ok&quot;</span> : 0<span class="token punctuation">,</span>
    <span class="token string">&quot;errmsg&quot;</span> : <span class="token string">&quot;not master and slaveOk=false&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;code&quot;</span> : 13435<span class="token punctuation">,</span>
    <span class="token string">&quot;codeName&quot;</span> : <span class="token string">&quot;NotMasterNoSlaveOk&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;<span class="token variable">$clusterTime</span>&quot;</span> : <span class="token punctuation">{</span>
        <span class="token string">&quot;clusterTime&quot;</span> : Timestamp<span class="token punctuation">(</span>1555664675<span class="token punctuation">,</span> 1<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;signature&quot;</span> : <span class="token punctuation">{</span>
            <span class="token string">&quot;hash&quot;</span> : BinData<span class="token punctuation">(</span>0<span class="token punctuation">,</span><span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">&quot;keyId&quot;</span> : NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
test:SECONDARY&gt; rs<span class="token punctuation">.</span>slaveOk<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 允许 次节点 进行读取</span>
test:SECONDARY&gt; show dbs<span class="token punctuation">;</span><span class="token comment"># 我们就可以查看到次节点的数据了</span>
admin   0<span class="token punctuation">.</span>000GB
config  0<span class="token punctuation">.</span>000GB
local   0<span class="token punctuation">.</span>000GB
test    0<span class="token punctuation">.</span>000GB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>至此MongoDB副本集已经搭建完成</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/4/2019, 11:06:30 AM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/mongodb/base/rs/" class="prev">
          MongoDB 副本集搭建
        </a></span> <!----></p></div> </div> <!----></div></div>
    <script src="/blog/assets/js/app.c6a0e20f.js" defer></script><script src="/blog/assets/js/40.9bec41c0.js" defer></script>
  </body>
</html>
